<div class="min-h-screen bg-gray-50">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-6">
      <%= link_to child_profile_book_path(@child_profile, @book), class: "text-gray-600 hover:text-gray-800 inline-flex items-center" do %>
        <%= icon "arrow-left", class: "w-5 h-5 mr-2" %>
        Back to Book
      <% end %>
    </div>

    <div class="bg-white rounded-lg shadow-md p-8">
      <h1 class="text-3xl font-bold text-gray-800 mb-2">Upload Drawings</h1>
      <p class="text-gray-600 mb-6">Add drawings to "<%= @book.title %>"</p>

      <% if @is_onboarding_book && @page_limit %>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
          <div class="flex items-start">
            <%= icon "info", class: "w-5 h-5 text-blue-600 mr-3 flex-shrink-0 mt-0.5" %>
            <div>
              <h3 class="text-sm font-semibold text-blue-900 mb-1">
                Page Limit: <%= @current_page_count %>/<%= @page_limit %>
              </h3>
              <p class="text-sm text-blue-800">
                <% remaining = @page_limit - @current_page_count %>
                <% if remaining > 0 %>
                  You can add <%= remaining %> more page(s) to this onboarding book.
                <% else %>
                  Your onboarding book is complete! Complete your account setup to create unlimited books.
                <% end %>
              </p>
            </div>
          </div>
        </div>
      <% end %>

      <%= form_with(model: [@child_profile, @book, @drawing], local: true, data: { controller: "drawings-upload" }) do |form| %>
        <% if @drawing && @drawing.errors.any? %>
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
            <h3 class="font-bold mb-2"><%= pluralize(@drawing.errors.count, "error") %> occurred:</h3>
            <ul class="list-disc list-inside">
              <% @drawing.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <% if flash[:alert] %>
          <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
            <%= flash[:alert] %>
          </div>
        <% end %>

        <!-- File Upload Section -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-3">
            Select Images
          </label>

          <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-purple-500 transition duration-200">
            <div class="space-y-4">
              <!-- Camera Capture (Mobile) -->
              <div>
                <label for="camera-input" class="inline-flex items-center justify-center bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition duration-200 cursor-pointer">
                  <%= icon "camera", class: "w-5 h-5 mr-2" %>
                  Take Photo
                </label>
                <%= form.file_field :images,
                    id: "camera-input",
                    multiple: true,
                    accept: "image/*",
                    capture: "environment",
                    class: "hidden",
                    data: { drawings_upload_target: "input", action: "change->drawings-upload#preview" } %>
              </div>

              <div class="text-gray-500">or</div>

              <!-- File Picker -->
              <div>
                <label for="file-input" class="inline-flex items-center justify-center bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200 cursor-pointer">
                  <%= icon "upload", class: "w-5 h-5 mr-2" %>
                  Choose from Gallery
                </label>
                <%= form.file_field :images,
                    id: "file-input",
                    multiple: true,
                    accept: "image/jpeg,image/png,image/heic,image/heif,image/webp",
                    class: "hidden",
                    data: { drawings_upload_target: "input", action: "change->drawings-upload#preview" } %>
              </div>
            </div>

            <p class="text-sm text-gray-500 mt-4">
              Supported formats: JPEG, PNG, HEIC, WebP (max 10MB per file)
            </p>
          </div>
        </div>

        <!-- Preview Section -->
        <div data-drawings-upload-target="previewContainer" class="hidden mb-6">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Selected Images</h3>
          <div data-drawings-upload-target="previewList" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <!-- Preview items will be inserted here by JavaScript -->
          </div>
        </div>

        <!-- Optional Tag Selection -->
        <div class="mb-6">
          <%= form.label :tag, "Tag (optional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.select :tag,
              [
                ['No tag', ''],
                ['Character', 'character'],
                ['Background', 'background'],
                ['Object', 'object']
              ],
              {},
              class: "w-full md:w-64 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" %>
          <p class="text-sm text-gray-500 mt-1">This tag will apply to all uploaded drawings</p>
        </div>

        <!-- Optional Caption -->
        <div class="mb-6">
          <%= form.label :caption, "Caption (optional)", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= form.text_area :caption,
              rows: 3,
              class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent",
              placeholder: "Add a caption for these drawings..." %>
        </div>

        <!-- Action Buttons -->
        <div class="flex space-x-3">
          <%= form.submit "Upload Drawings",
              class: "bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition duration-200 cursor-pointer",
              data: { drawings_upload_target: "submitButton" } %>
          <%= link_to "Cancel", child_profile_book_path(@child_profile, @book),
              class: "bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 transition duration-200 inline-block" %>
        </div>
      <% end %>
    </div>
  </div>
</div>
