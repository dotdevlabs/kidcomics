<div data-controller="book-editor" data-book-editor-auto-save-url-value="<%= auto_save_editor_child_profile_book_path(@child_profile, @book) %>" class="min-h-screen bg-gray-50 pb-20">
  <!-- Header Section -->
  <div class="bg-white border-b border-gray-200 sticky top-0 z-10">
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-4">
          <%= link_to child_profile_book_path(@child_profile, @book), class: "text-gray-600 hover:text-gray-900" do %>
            <i data-lucide="chevron-left" class="w-6 h-6"></i>
          <% end %>
          <h1 class="text-2xl font-bold text-gray-900">Book Editor</h1>
        </div>

        <div class="flex items-center gap-3">
          <!-- Auto-save Indicator -->
          <span data-book-editor-target="autoSaveIndicator" class="text-sm text-gray-500">
            <i data-lucide="save" class="w-4 h-4 inline"></i>
            <span data-book-editor-target="saveStatus">Saved</span>
          </span>

          <!-- Preview Button -->
          <%= link_to preview_editor_child_profile_book_path(@child_profile, @book),
                      class: "btn btn-secondary flex items-center gap-2",
                      target: "_blank" do %>
            <i data-lucide="eye" class="w-4 h-4"></i>
            <span>Preview</span>
          <% end %>
        </div>
      </div>

      <!-- AI Book Assistant -->
      <div data-controller="book-ai-assistant"
           data-book-ai-assistant-book-id-value="<%= @book.id %>"
           data-book-ai-assistant-update-url-value="<%= auto_save_editor_child_profile_book_path(@child_profile, @book) %>"
           class="space-y-4">

        <!-- Current Book Info Display -->
        <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-6 border border-purple-200">
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
              <i data-lucide="sparkles" class="w-8 h-8 text-purple-600"></i>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-gray-900 mb-2">Book Details</h3>
              <div class="space-y-2 text-sm">
                <div>
                  <span class="font-medium text-gray-700">Title:</span>
                  <span class="text-gray-900 ml-2" data-book-ai-assistant-target="titleDisplay"><%= @book.title %></span>
                </div>
                <% if @book.dedication.present? %>
                  <div>
                    <span class="font-medium text-gray-700">Dedication:</span>
                    <span class="text-gray-900 ml-2" data-book-ai-assistant-target="dedicationDisplay"><%= @book.dedication %></span>
                  </div>
                <% end %>
                <div>
                  <span class="font-medium text-gray-700">Edit Mode:</span>
                  <span class="text-gray-900 ml-2" data-book-ai-assistant-target="editModeDisplay">
                    <%= @book.edit_mode == 'parent_only' ? 'Parents Only' : 'Everyone (Shared)' %>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- AI Suggestions -->
        <div class="bg-white rounded-lg border border-gray-200 p-6">
          <h3 class="text-md font-semibold text-gray-900 mb-4 flex items-center gap-2">
            <i data-lucide="message-square" class="w-5 h-5 text-blue-600"></i>
            Refine with AI
          </h3>

          <p class="text-sm text-gray-600 mb-4">
            Tell me what you'd like to change about your book, or upload a new drawing for inspiration!
          </p>

          <!-- AI Chat Messages -->
          <div data-book-ai-assistant-target="messages"
               class="space-y-3 mb-4 max-h-96 overflow-y-auto">
            <!-- Initial AI message -->
            <div class="flex gap-3">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center">
                  <i data-lucide="bot" class="w-4 h-4 text-blue-600"></i>
                </div>
              </div>
              <div class="flex-1 bg-blue-50 rounded-lg p-3">
                <p class="text-sm text-gray-800">
                  Hi! I'm here to help you refine "<%= @book.title %>". You can:
                </p>
                <ul class="text-sm text-gray-700 mt-2 space-y-1 ml-4 list-disc">
                  <li>Upload drawings for me to analyze</li>
                  <li>Ask me to suggest a better title</li>
                  <li>Tell me what the dedication should say</li>
                  <li>Change who can edit this book</li>
                </ul>
                <p class="text-sm text-gray-600 mt-2 italic">
                  Just type what you'd like to change!
                </p>
              </div>
            </div>
          </div>

          <!-- Image Upload Area -->
          <div class="mb-4">
            <label class="block">
              <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-purple-400 transition cursor-pointer">
                <input type="file"
                       accept="image/*"
                       class="hidden"
                       data-action="change->book-ai-assistant#handleImageUpload"
                       data-book-ai-assistant-target="imageInput">
                <i data-lucide="camera" class="w-8 h-8 mx-auto text-gray-400 mb-2"></i>
                <p class="text-sm text-gray-600">Click to upload a drawing</p>
                <p class="text-xs text-gray-500 mt-1">AI will analyze it and suggest updates</p>
              </div>
            </label>
          </div>

          <!-- Chat Input -->
          <div class="flex gap-2">
            <%= form_with url: "#", method: :post, class: "flex-1 flex gap-2", data: { action: "submit->book-ai-assistant#sendMessage" } do |f| %>
              <%= f.text_field :message,
                              placeholder: "Tell me what you'd like to change...",
                              class: "flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",
                              data: { book_ai_assistant_target: "messageInput" },
                              autocomplete: "off" %>
              <%= f.submit "Send",
                          class: "bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition inline-flex items-center gap-2",
                          data: { book_ai_assistant_target: "sendButton" } %>
            <% end %>
          </div>

          <!-- Quick Actions -->
          <div class="mt-4 flex flex-wrap gap-2">
            <button type="button"
                    class="text-sm px-3 py-1 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition"
                    data-action="click->book-ai-assistant#quickAction"
                    data-message="Suggest a better title based on the story">
              Suggest Title
            </button>
            <button type="button"
                    class="text-sm px-3 py-1 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition"
                    data-action="click->book-ai-assistant#quickAction"
                    data-message="Write a dedication for this book">
              Add Dedication
            </button>
            <button type="button"
                    class="text-sm px-3 py-1 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition"
                    data-action="click->book-ai-assistant#quickAction"
                    data-message="Make this parents only">
              Lock to Parents
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cover Section -->
  <div class="container mx-auto px-4 py-6">
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
      <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
        <i data-lucide="image" class="w-5 h-5"></i>
        Cover Image
      </h2>

      <%= render "editor/books/cover_editor", book: @book, child_profile: @child_profile %>
    </div>
  </div>

  <!-- Pages Section -->
  <div class="container mx-auto px-4 py-6">
    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-gray-900 flex items-center gap-2">
          <i data-lucide="book-open" class="w-5 h-5"></i>
          Pages (<%= @drawings.count %>)
        </h2>

        <% if @can_add_pages %>
          <%= link_to editor_child_profile_book_pages_path(@child_profile, @book),
                      data: { turbo_method: :post },
                      class: "btn btn-primary flex items-center gap-2" do %>
            <i data-lucide="plus" class="w-4 h-4"></i>
            <span>Add Page</span>
          <% end %>
        <% else %>
          <span class="text-sm text-gray-500">Onboarding books are limited to 5 pages</span>
        <% end %>
      </div>

      <!-- Pages Grid -->
      <div data-controller="pages-reorder"
           data-pages-reorder-url-value="<%= editor_child_profile_book_path(@child_profile, @book) %>"
           class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <% @drawings.each_with_index do |drawing, index| %>
          <%= render "editor/books/page_card",
                     drawing: drawing,
                     book: @book,
                     child_profile: @child_profile,
                     index: index %>
        <% end %>
      </div>

      <% if @drawings.empty? %>
        <div class="text-center py-12">
          <i data-lucide="book-open" class="w-16 h-16 mx-auto text-gray-300 mb-4"></i>
          <p class="text-gray-500 mb-4">No pages yet. Add your first page to get started!</p>
          <%= link_to editor_child_profile_book_pages_path(@child_profile, @book),
                      data: { turbo_method: :post },
                      class: "btn btn-primary inline-flex items-center gap-2" do %>
            <i data-lucide="plus" class="w-4 h-4"></i>
            <span>Add First Page</span>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
